import{j as e}from"./ui-core-DSsgHKQi.js";import{r as c}from"./react-core-C2Lho-Ro.js";import{b as je,u as J,c as ge,d as ye}from"./form-DucUJAz-.js";import{a as be,B as _,J as D,s as L}from"./index-CwoeutiG.js";import{z as x,s as Ne}from"./index-CK06S98z.js";import{I as F}from"./input-BL695Knw.js";import{B as G}from"./badge-D22ac54H.js";import{C as u,a as h,b as p,d as f}from"./card-D01js5Yw.js";import{E as ve,S as k,a as A,b as E,c as T,d as i}from"./enhanced-page-header-Cial-IQU.js";import{D as Se,a as we,b as _e,c as Fe,d as Ce,e as Me}from"./dialog-KvZ9DuRC.js";import{F as Pe,a as j,b as g,c as y,d as b,e as N}from"./form-Bxhwt7Ly.js";import{L as W,E as X}from"./loading-state-CgPl31pa.js";import{o as Z,D as De,u as Le,v as ke,w as ee,U as te,p as Ae,x as se,L as Ee}from"./utils-D1Dv2Yo8.js";import{m as ae}from"./animation-CC1ogdXw.js";import{f as q}from"./format-BEMO4FpZ.js";import"./auth-D43A8yQe.js";import"./label-Cgr4Vjb0.js";function Xe(){const[C,re]=c.useState(""),[M,ne]=c.useState("all"),[v,le]=c.useState("all"),[V,de]=c.useState("date"),[R,$]=c.useState("desc"),[oe,S]=c.useState(!1),[w,Y]=c.useState(null);be();const ie=()=>{const s=q(new Date,"yyyyMMdd"),d=Math.floor(1e3+Math.random()*9e3);return`REC${s}${d}`},ce=x.object({student_id:x.string({required_error:"Student is required"}),amount:x.coerce.number().min(1,"Amount must be greater than 0"),date:x.string().refine(t=>new Date(t)<=new Date,{message:"Date cannot be in the future"}),payment_mode:x.string().refine(t=>["Cash","Online","Cheque"].includes(t),{message:"Invalid payment mode"}),receipt_number:x.string().min(3,"Receipt number is required"),purpose:x.string().optional()}),B=je(),{data:o=[],isLoading:Q}=J({queryKey:["students"],queryFn:async()=>{const{data:t,error:s}=await L.from("students").select("*");if(s)throw s;return t||[]}}),{data:U=[],isLoading:me}=J({queryKey:["feeTransactions"],queryFn:async()=>{const{data:t,error:s}=await L.from("fee_transactions").select("*");if(s)throw s;return t||[]}}),P=o.reduce((t,s)=>t+(s.total_fees||0),0),I=o.reduce((t,s)=>t+(s.paid_fees||0),0),xe=P-I,K=P>0?Math.round(I/P*100):0,O=ge({mutationFn:async t=>{const{data:s,error:d}=await L.from("fee_transactions").insert(t).select();if(d)throw d;const r=o.find(n=>n.id===t.student_id);if(r){const n=(r.paid_fees||0)+t.amount,l=n>=r.total_fees?"Paid":n>0?"Partial":"Pending",{error:a}=await L.from("students").update({paid_fees:n,fee_status:l}).eq("id",r.id);if(a)throw a}return s},onSuccess:()=>{B.invalidateQueries({queryKey:["students"]}),B.invalidateQueries({queryKey:["feeTransactions"]}),S(!1),D.success("Payment added successfully")},onError:t=>{D.error(`Failed to add payment: ${t.message}`)}}),H=U.filter(t=>{const s=o.find(l=>l.id===t.student_id),d=(s==null?void 0:s.full_name.toLowerCase().includes(C.toLowerCase()))||!1,r=M==="all"||M==="paid"&&t.payment_mode!==null||M==="pending"&&t.payment_mode===null;let n=!0;if(v!=="all"){const l=new Date,a=new Date(t.date);if(v==="thisMonth")n=a.getMonth()===l.getMonth()&&a.getFullYear()===l.getFullYear();else if(v==="lastMonth"){const m=l.getMonth()===0?11:l.getMonth()-1,fe=l.getMonth()===0?l.getFullYear()-1:l.getFullYear();n=a.getMonth()===m&&a.getFullYear()===fe}else v==="thisYear"&&(n=a.getFullYear()===l.getFullYear())}return d&&r&&n}).sort((t,s)=>{if(V==="date"){const d=new Date(t.date).getTime(),r=new Date(s.date).getTime();return R==="asc"?d-r:r-d}else return R==="asc"?t.amount-s.amount:s.amount-t.amount}),z=t=>{V===t?$(R==="asc"?"desc":"asc"):(de(t),$("desc"))},ue=()=>{try{let t=`Student,Class,Date,Amount,Payment Mode,Receipt,Purpose
`;U.forEach(n=>{const l=o.find(a=>a.id===n.student_id);if(l){const a=[l.full_name,`Class ${l.class}`,new Date(n.date).toLocaleDateString(),`₹${n.amount}`,n.payment_mode,n.receipt_number,n.purpose||""].map(m=>`"${m}"`).join(",");t+=a+`
`}});const s=new Blob([t],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(s),r=document.createElement("a");r.setAttribute("href",d),r.setAttribute("download",`fee_transactions_${q(new Date,"yyyyMMdd")}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),D.success("Fee data exported successfully")}catch(t){console.error("Export error:",t),D.error("Failed to export fee data")}},he=t=>{Y(t),S(!0)};c.useEffect(()=>{},[w]);const pe=()=>{const t={student_id:w||"",amount:0,date:q(new Date,"yyyy-MM-dd"),payment_mode:"Cash",receipt_number:ie(),purpose:"Fee Payment"},s=ye({resolver:Ne(ce),defaultValues:t}),d=s.watch("student_id"),r=o.find(a=>a.id===d),n=r?r.total_fees-r.paid_fees:0;c.useEffect(()=>{w&&s.setValue("student_id",w,{shouldValidate:!0})},[w,s]);const l=a=>{O.mutate(a)};return e.jsx(Pe,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(l),className:"space-y-4",children:[e.jsx(j,{control:s.control,name:"student_id",render:({field:a})=>e.jsxs(g,{children:[e.jsx(y,{children:"Student"}),e.jsxs(k,{onValueChange:a.onChange,defaultValue:a.value,children:[e.jsx(b,{children:e.jsx(A,{children:e.jsx(E,{placeholder:"Select student"})})}),e.jsx(T,{children:o.map(m=>e.jsxs(i,{value:m.id,children:[m.full_name," - Class ",m.class]},m.id))})]}),e.jsx(N,{})]})}),r&&e.jsx("div",{className:"text-sm p-3 rounded-md bg-muted/50 border border-muted-foreground/10",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("span",{children:"Total Fees:"}),e.jsxs("span",{className:"text-right font-medium",children:["₹",r.total_fees.toLocaleString()]}),e.jsx("span",{children:"Paid Fees:"}),e.jsxs("span",{className:"text-right font-medium",children:["₹",r.paid_fees.toLocaleString()]}),e.jsx("span",{children:"Outstanding:"}),e.jsxs("span",{className:"text-right font-medium text-red-500",children:["₹",n.toLocaleString()]})]})}),e.jsx(j,{control:s.control,name:"amount",render:({field:a})=>e.jsxs(g,{children:[e.jsx(y,{children:"Amount (₹)"}),e.jsx(b,{children:e.jsx(F,{type:"number",placeholder:"0",...a})}),e.jsx(N,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(j,{control:s.control,name:"date",render:({field:a})=>e.jsxs(g,{children:[e.jsx(y,{children:"Payment Date"}),e.jsx(b,{children:e.jsx(F,{type:"date",...a,max:q(new Date,"yyyy-MM-dd")})}),e.jsx(N,{})]})}),e.jsx(j,{control:s.control,name:"payment_mode",render:({field:a})=>e.jsxs(g,{children:[e.jsx(y,{children:"Payment Mode"}),e.jsxs(k,{onValueChange:a.onChange,defaultValue:a.value,children:[e.jsx(b,{children:e.jsx(A,{children:e.jsx(E,{placeholder:"Select mode"})})}),e.jsxs(T,{children:[e.jsx(i,{value:"Cash",children:"Cash"}),e.jsx(i,{value:"Online",children:"Online"}),e.jsx(i,{value:"Cheque",children:"Cheque"})]})]}),e.jsx(N,{})]})})]}),e.jsx(j,{control:s.control,name:"receipt_number",render:({field:a})=>e.jsxs(g,{children:[e.jsx(y,{children:"Receipt Number"}),e.jsx(b,{children:e.jsx(F,{...a})}),e.jsx(N,{})]})}),e.jsx(j,{control:s.control,name:"purpose",render:({field:a})=>e.jsxs(g,{children:[e.jsx(y,{children:"Purpose (Optional)"}),e.jsx(b,{children:e.jsx(F,{placeholder:"Fee payment purpose",...a})}),e.jsx(N,{})]})}),e.jsxs(Me,{children:[e.jsx(_,{type:"button",variant:"outline",onClick:()=>{S(!1),Y(null)},children:"Cancel"}),e.jsx(_,{type:"submit",disabled:O.isPending,children:O.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):"Add Payment"})]})]})})};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx(ve,{title:"Fee Management",description:"Manage student fees and payments",action:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(_,{onClick:()=>S(!0),className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"})," Add Payment"]}),e.jsxs(_,{variant:"outline",onClick:ue,children:[e.jsx(De,{className:"h-4 w-4 mr-2"})," Export"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs(u,{className:"bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 border-b-4 border-blue-500",children:[e.jsx(h,{className:"pb-2",children:e.jsxs(p,{className:"flex items-center gap-2 text-sm font-medium text-blue-600 dark:text-blue-400",children:[e.jsx(Le,{className:"h-4 w-4"})," Total Fees"]})}),e.jsxs(f,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:["₹",P.toLocaleString()]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"All students"})]})]}),e.jsxs(u,{className:"bg-gradient-to-br from-green-50 to-teal-50 dark:from-green-950/30 dark:to-teal-950/30 border-b-4 border-green-500",children:[e.jsx(h,{className:"pb-2",children:e.jsxs(p,{className:"flex items-center gap-2 text-sm font-medium text-green-600 dark:text-green-400",children:[e.jsx(ke,{className:"h-4 w-4"})," Collected Fees"]})}),e.jsxs(f,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:["₹",I.toLocaleString()]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[K,"% of total"]})]})]}),e.jsxs(u,{className:"bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 border-b-4 border-amber-500",children:[e.jsx(h,{className:"pb-2",children:e.jsxs(p,{className:"flex items-center gap-2 text-sm font-medium text-amber-600 dark:text-amber-400",children:[e.jsx(ee,{className:"h-4 w-4"})," Pending Fees"]})}),e.jsxs(f,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:["₹",xe.toLocaleString()]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[100-K,"% remaining"]})]})]}),e.jsxs(u,{className:"bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30 border-b-4 border-purple-500",children:[e.jsx(h,{className:"pb-2",children:e.jsxs(p,{className:"flex items-center gap-2 text-sm font-medium text-purple-600 dark:text-purple-400",children:[e.jsx(te,{className:"h-4 w-4"})," Students"]})}),e.jsxs(f,{children:[e.jsx("div",{className:"text-2xl font-bold",children:o.length}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[o.filter(t=>t.fee_status==="Paid").length," paid in full"]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ae,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(F,{placeholder:"Search students...",value:C,onChange:t=>re(t.target.value),className:"pl-10 bg-background/60 backdrop-blur-sm"})]}),e.jsxs(k,{value:M,onValueChange:ne,children:[e.jsx(A,{children:e.jsx(E,{placeholder:"Filter by status"})}),e.jsxs(T,{children:[e.jsx(i,{value:"all",children:"All Statuses"}),e.jsx(i,{value:"paid",children:"Paid"}),e.jsx(i,{value:"pending",children:"Pending"})]})]}),e.jsxs(k,{value:v,onValueChange:le,children:[e.jsx(A,{children:e.jsx(E,{placeholder:"Filter by period"})}),e.jsxs(T,{children:[e.jsx(i,{value:"all",children:"All Time"}),e.jsx(i,{value:"thisMonth",children:"This Month"}),e.jsx(i,{value:"lastMonth",children:"Last Month"}),e.jsx(i,{value:"thisYear",children:"This Year"})]})]})]}),e.jsxs(u,{className:"shadow-sm border-muted",children:[e.jsx(h,{className:"pb-3",children:e.jsx(p,{className:"text-lg",children:"Fee Transactions"})}),e.jsx(f,{children:me||Q?e.jsx(W,{}):H.length===0?e.jsx(X,{icon:e.jsx(ee,{className:"h-10 w-10 text-muted-foreground"}),title:"No transactions found",description:"No fee transactions match your current filters."}):e.jsx("div",{className:"overflow-hidden rounded-md border",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-muted/50",children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Student"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground cursor-pointer",onClick:()=>z("date"),children:e.jsxs("div",{className:"flex items-center gap-1",children:["Date",e.jsx(se,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground cursor-pointer",onClick:()=>z("amount"),children:e.jsxs("div",{className:"flex items-center gap-1",children:["Amount",e.jsx(se,{className:"h-3 w-3"})]})}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Mode"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Receipt #"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Purpose"})]})}),e.jsx("tbody",{children:H.map(t=>{const s=o.find(d=>d.id===t.student_id);return e.jsxs(ae.tr,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"border-t hover:bg-muted/30",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:(s==null?void 0:s.full_name)||"Unknown"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Class ",s==null?void 0:s.class]})]})}),e.jsx("td",{className:"px-4 py-3",children:new Date(t.date).toLocaleDateString()}),e.jsxs("td",{className:"px-4 py-3 font-medium",children:["₹",t.amount.toLocaleString()]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(G,{variant:t.payment_mode==="Cash"?"outline":t.payment_mode==="Online"?"secondary":"default",children:t.payment_mode})}),e.jsx("td",{className:"px-4 py-3 text-sm",children:t.receipt_number}),e.jsx("td",{className:"px-4 py-3 text-sm",children:t.purpose||"-"})]},t.id)})})]})})})})]}),e.jsxs(u,{className:"shadow-sm border-muted",children:[e.jsx(h,{className:"pb-3",children:e.jsx(p,{className:"text-lg",children:"Student Fee Status"})}),e.jsx(f,{children:Q?e.jsx(W,{}):o.length===0?e.jsx(X,{icon:e.jsx(te,{className:"h-10 w-10 text-muted-foreground"}),title:"No students found",description:"No students have been added to the system yet."}):e.jsx("div",{className:"overflow-hidden rounded-md border",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-muted/50",children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Student"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Class"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Total Fees"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Paid"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Balance"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-muted-foreground",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-sm font-medium text-muted-foreground",children:"Action"})]})}),e.jsx("tbody",{children:o.filter(t=>t.full_name.toLowerCase().includes(C.toLowerCase())||t.class.toString().includes(C)).map(t=>{const s=t.total_fees-t.paid_fees,d=t.total_fees>0?Math.round(t.paid_fees/t.total_fees*100):0;return e.jsxs(ae.tr,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"border-t hover:bg-muted/30",children:[e.jsx("td",{className:"px-4 py-3 font-medium",children:t.full_name}),e.jsxs("td",{className:"px-4 py-3",children:["Class ",t.class]}),e.jsxs("td",{className:"px-4 py-3",children:["₹",t.total_fees.toLocaleString()]}),e.jsxs("td",{className:"px-4 py-3 text-green-600 font-medium",children:["₹",t.paid_fees.toLocaleString()]}),e.jsxs("td",{className:"px-4 py-3 text-red-500 font-medium",children:["₹",s.toLocaleString()]}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs(G,{className:t.fee_status==="Paid"?"bg-green-100 text-green-800 hover:bg-green-200":t.fee_status==="Partial"?"bg-amber-100 text-amber-800 hover:bg-amber-200":"bg-red-100 text-red-800 hover:bg-red-200",children:[t.fee_status," ",t.fee_status==="Partial"&&`(${d}%)`]})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs(_,{size:"sm",variant:"ghost",className:"text-blue-600 hover:text-blue-800 hover:bg-blue-50",onClick:()=>he(t.id),children:[e.jsx(Z,{className:"h-3.5 w-3.5 mr-1"})," Add Payment"]})})]},t.id)})})]})})})})]}),e.jsx(Se,{open:oe,onOpenChange:t=>{S(t),t||Y(null)},children:e.jsxs(we,{className:"sm:max-w-[500px]",children:[e.jsxs(_e,{children:[e.jsx(Fe,{children:"Add Fee Payment"}),e.jsx(Ce,{children:"Record a new fee payment for a student."})]}),e.jsx(pe,{})]})})]})}export{Xe as default};
